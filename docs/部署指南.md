# SmartVoyage 部署指南

> 文档版本：V2.0  
> 更新日期：2026-01-19

---

## 目录

1. [环境要求](#1-环境要求)
2. [快速部署（Docker）](#2-快速部署docker)
3. [手动部署](#3-手动部署)
4. [配置说明](#4-配置说明)
5. [服务管理](#5-服务管理)
6. [故障排查](#6-故障排查)
7. [生产环境建议](#7-生产环境建议)

---

## 1. 环境要求

### 1.1 硬件要求

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 20GB | 50GB+ |
| 网络 | 1Mbps | 10Mbps+ |

### 1.2 软件要求

| 软件 | 版本要求 | 说明 |
|------|----------|------|
| Python | 3.10+ | 推荐 3.11 |
| MySQL | 8.0+ | 数据存储 |
| Docker | 20.10+ | 容器化部署（可选） |
| Docker Compose | 2.0+ | 服务编排（可选） |

### 1.3 端口需求

确保以下端口未被占用：

| 端口 | 服务 |
|------|------|
| 3306 | MySQL |
| 5005 | Weather Agent |
| 5006 | Ticket Agent |
| 5007 | Order Agent |
| 8000 | Weather MCP |
| 8001 | Ticket MCP |
| 8002 | Order MCP |
| 8501 | Web UI |

---

## 2. 快速部署（Docker）

### 2.1 前置准备

```bash
# 克隆项目
git clone https://github.com/your-org/smartvoyage.git
cd smartvoyage

# 复制环境变量配置
cp .env .env

# 编辑配置（必须设置 LLM_API_KEY）
nano .env
```

### 2.2 配置环境变量

编辑 `.env` 文件：

```bash
# 大模型配置（必填）
LLM_API_KEY=your-api-key-here
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_MODEL=qwen-plus

# 数据库配置（可选，有默认值）
DB_PASSWORD=root123
DB_NAME=travel_rag
```

### 2.3 一键启动

```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 2.4 验证部署

```bash
# 检查服务健康状态
curl http://localhost:5005/.well-known/agent.json
curl http://localhost:5006/.well-known/agent.json
curl http://localhost:5007/.well-known/agent.json

# 访问 Web UI
open http://localhost:8501
```

### 2.5 初始化测试数据

```bash
# 进入容器执行初始化脚本
docker-compose exec web python scripts/init_data.py
```

### 2.6 停止服务

```bash
# 停止所有服务
docker-compose down

# 停止并删除数据卷（清除数据）
docker-compose down -v
```

---

## 3. 手动部署

### 3.1 安装依赖

```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 3.2 配置数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行初始化脚本
source sql/init_database.sql;

# 退出
exit;
```

### 3.3 配置环境变量

```bash
# 复制配置文件
cp .env .env

# 编辑配置
nano .env
```

必须配置的项目：

```bash
# 大模型 API Key
LLM_API_KEY=your-api-key-here

# 数据库连接
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your-password
DB_NAME=travel_rag
```

### 3.4 启动服务

**方式一：使用启动脚本**

```bash
chmod +x scripts/start_services.sh
./scripts/start_services.sh
```

**方式二：手动启动各服务**

```bash
# 终端1：启动 MCP 服务
python -m src.mcp_servers.weather_mcp &
python -m src.mcp_servers.ticket_mcp &
python -m src.mcp_servers.order_mcp &

# 终端2：启动 Agent 服务
python -m src.agents.weather_agent &
python -m src.agents.ticket_agent &
python -m src.agents.order_agent &

# 终端3：启动 Web UI
streamlit run src/app.py
```

### 3.5 初始化数据

```bash
python scripts/init_data.py
```

### 3.6 验证服务

```bash
python scripts/health_check.py
```

---

## 4. 配置说明

### 4.1 环境变量一览

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| **LLM 配置** |||
| LLM_API_KEY | - | 大模型 API Key（必填） |
| LLM_BASE_URL | https://dashscope.aliyuncs.com/compatible-mode/v1 | API 地址 |
| LLM_MODEL | qwen-plus | 模型名称 |
| LLM_TEMPERATURE | 0.1 | 生成温度 |
| **数据库配置** |||
| DB_HOST | localhost | 数据库主机 |
| DB_PORT | 3306 | 数据库端口 |
| DB_USER | root | 数据库用户 |
| DB_PASSWORD | root | 数据库密码 |
| DB_NAME | travel_rag | 数据库名称 |
| **服务端口** |||
| WEATHER_AGENT_PORT | 5005 | 天气 Agent 端口 |
| TICKET_AGENT_PORT | 5006 | 票务 Agent 端口 |
| ORDER_AGENT_PORT | 5007 | 订票 Agent 端口 |
| WEATHER_MCP_PORT | 8000 | 天气 MCP 端口 |
| TICKET_MCP_PORT | 8001 | 票务 MCP 端口 |
| ORDER_MCP_PORT | 8002 | 订单 MCP 端口 |

### 4.2 支持的 LLM 提供商

| 提供商 | BASE_URL | 支持模型 |
|--------|----------|----------|
| 阿里云通义千问 | https://dashscope.aliyuncs.com/compatible-mode/v1 | qwen-plus, qwen-max |
| OpenAI | https://api.openai.com/v1 | gpt-4, gpt-3.5-turbo |
| Azure OpenAI | https://your-resource.openai.azure.com | gpt-4, gpt-35-turbo |
| 月之暗面 Kimi | https://api.moonshot.cn/v1 | moonshot-v1-8k |
| 智谱 AI | https://open.bigmodel.cn/api/paas/v4 | glm-4 |

### 4.3 配置示例

**使用 OpenAI：**
```bash
LLM_API_KEY=sk-xxxx
LLM_BASE_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4
```

**使用 Kimi：**
```bash
LLM_API_KEY=sk-xxxx
LLM_BASE_URL=https://api.moonshot.cn/v1
LLM_MODEL=moonshot-v1-8k
```

---

## 5. 服务管理

### 5.1 Docker 环境

```bash
# 查看所有服务状态
docker-compose ps

# 查看特定服务日志
docker-compose logs -f weather-agent

# 重启单个服务
docker-compose restart weather-agent

# 进入容器调试
docker-compose exec web bash

# 扩容服务（如需要）
docker-compose up -d --scale ticket-agent=2
```

### 5.2 手动部署环境

```bash
# 使用 systemd 管理（推荐）
sudo systemctl start smartvoyage
sudo systemctl stop smartvoyage
sudo systemctl status smartvoyage

# 使用 supervisord 管理
supervisorctl start smartvoyage:*
supervisorctl stop smartvoyage:*
supervisorctl status
```

### 5.3 健康检查

```bash
# 运行健康检查脚本
python scripts/health_check.py

# 检查单个服务
curl -f http://localhost:5005/.well-known/agent.json || echo "Weather Agent 异常"
curl -f http://localhost:5006/.well-known/agent.json || echo "Ticket Agent 异常"
curl -f http://localhost:5007/.well-known/agent.json || echo "Order Agent 异常"
```

---

## 6. 故障排查

### 6.1 常见问题

#### 问题1：数据库连接失败

**错误信息：**
```
mysql.connector.errors.InterfaceError: 2003: Can't connect to MySQL server
```

**解决方案：**
1. 检查 MySQL 服务是否启动
2. 检查数据库配置是否正确
3. 检查防火墙是否放行 3306 端口

```bash
# 检查 MySQL 状态
sudo systemctl status mysql

# 测试连接
mysql -h localhost -u root -p -e "SELECT 1"
```

#### 问题2：LLM API 调用失败

**错误信息：**
```
Error code: 401 - invalid_api_key
```

**解决方案：**
1. 检查 API Key 是否正确
2. 检查 API Key 是否有余额/配额
3. 检查 BASE_URL 是否匹配

```bash
# 测试 API
curl -X POST ${LLM_BASE_URL}/chat/completions \
  -H "Authorization: Bearer ${LLM_API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{"model":"qwen-plus","messages":[{"role":"user","content":"hi"}]}'
```

#### 问题3：端口被占用

**错误信息：**
```
OSError: [Errno 98] Address already in use
```

**解决方案：**
```bash
# 查找占用端口的进程
lsof -i :5005
netstat -tlnp | grep 5005

# 终止进程
kill -9 <PID>

# 或修改配置使用其他端口
export WEATHER_AGENT_PORT=5015
```

#### 问题4：MCP 连接失败

**错误信息：**
```
httpx.ConnectError: [Connect call failed]
```

**解决方案：**
1. 确保 MCP 服务已启动
2. 检查 MCP URL 配置是否正确
3. 检查网络连通性

```bash
# 检查 MCP 服务
curl http://localhost:8000/mcp
curl http://localhost:8001/mcp
curl http://localhost:8002/mcp
```

### 6.2 日志查看

```bash
# Docker 环境
docker-compose logs -f --tail=100

# 手动部署
tail -f logs/app.log

# 查看特定级别日志
grep ERROR logs/app.log
grep WARNING logs/app.log
```

### 6.3 调试模式

```bash
# 启用调试模式
export LOG_LEVEL=DEBUG

# 重启服务
docker-compose restart
# 或
./scripts/start_services.sh
```

---

## 7. 生产环境建议

### 7.1 安全加固

1. **修改默认密码**
   ```bash
   # 数据库密码
   DB_PASSWORD=strong-random-password
   ```

2. **启用 HTTPS**
   ```nginx
   server {
       listen 443 ssl;
       ssl_certificate /path/to/cert.pem;
       ssl_certificate_key /path/to/key.pem;
       
       location / {
           proxy_pass http://localhost:8501;
       }
   }
   ```

3. **限制网络访问**
   ```bash
   # 只允许内网访问 MCP 服务
   iptables -A INPUT -p tcp --dport 8000:8002 -s 10.0.0.0/8 -j ACCEPT
   iptables -A INPUT -p tcp --dport 8000:8002 -j DROP
   ```

### 7.2 性能优化

1. **数据库优化**
   ```sql
   -- 添加索引
   ALTER TABLE train_tickets ADD INDEX idx_route_date 
       (departure_city, arrival_city, departure_time);
   
   -- 启用查询缓存
   SET GLOBAL query_cache_size = 67108864;
   ```

2. **连接池配置**
   ```python
   # 在 settings.py 中
   DB_POOL_SIZE = 10
   DB_MAX_OVERFLOW = 20
   ```

3. **LLM 缓存**
   ```python
   # 启用响应缓存
   LLM_CACHE_ENABLED = True
   LLM_CACHE_TTL = 3600
   ```

### 7.3 高可用部署

```yaml
# docker-compose.prod.yml
services:
  ticket-agent:
    deploy:
      replicas: 3
      restart_policy:
        condition: on-failure
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
```

### 7.4 监控告警

1. **Prometheus 指标**
   ```python
   # 添加指标导出
   from prometheus_client import Counter, Histogram
   
   REQUEST_COUNT = Counter('request_total', 'Total requests')
   REQUEST_LATENCY = Histogram('request_latency_seconds', 'Request latency')
   ```

2. **健康检查端点**
   ```python
   @app.get("/health")
   async def health():
       return {"status": "healthy", "timestamp": datetime.now().isoformat()}
   ```

3. **告警配置**
   ```yaml
   # alertmanager.yml
   receivers:
     - name: 'slack'
       slack_configs:
         - channel: '#alerts'
           text: 'SmartVoyage 服务异常'
   ```

### 7.5 备份策略

```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=/backup/mysql

mysqldump -u root -p${DB_PASSWORD} ${DB_NAME} | gzip > ${BACKUP_DIR}/travel_rag_${DATE}.sql.gz

# 保留最近7天
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +7 -delete
```

添加到 crontab：
```bash
0 2 * * * /path/to/backup.sh
```

---

## 附录

### A. 常用命令速查

| 操作 | Docker | 手动部署 |
|------|--------|----------|
| 启动所有服务 | `docker-compose up -d` | `./scripts/start_services.sh` |
| 停止所有服务 | `docker-compose down` | `pkill -f smartvoyage` |
| 查看日志 | `docker-compose logs -f` | `tail -f logs/app.log` |
| 健康检查 | `docker-compose ps` | `python scripts/health_check.py` |
| 重启服务 | `docker-compose restart` | 手动重启各进程 |

### B. 联系支持

- 文档：https://github.com/your-org/smartvoyage/wiki
- Issues：https://github.com/your-org/smartvoyage/issues
- 邮箱：kerro99920@gmail.com
