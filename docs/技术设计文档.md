# SmartVoyage 智能旅行助手系统

## 技术设计文档

---

<div align="center">

| 项目信息 | |
|:--------:|:---:|
| **文档编号** | SV-TDD-2026-001 |
| **版本号** | V2.0 |
| **密级** | 内部公开 |
| **编写日期** | 2026-01-18 |
| **编写部门** | 研发中心 |

</div>

---

## 修订记录

| 版本 | 日期 |  修订人  | 修订内容 | 审核人 |
|:----:|:----:|:-----:|:--------:|:------:|
| V1.0 | 2025-10-01 | kerro | 初稿 | kerro |
| V1.5 | 2025-12-15 | kerro | 新增票务模块 | kerro |
| V2.0 | 2026-01-18 | kerro | 新增订票功能 | kerro |

---

## 目录

1. [引言](#1-引言)
2. [系统概述](#2-系统概述)
3. [系统架构](#3-系统架构)
4. [模块设计](#4-模块设计)
5. [数据库设计](#5-数据库设计)
6. [接口设计](#6-接口设计)
7. [部署架构](#7-部署架构)
8. [安全设计](#8-安全设计)

---

## 1. 引言

### 1.1 编写目的

本文档是SmartVoyage智能旅行助手系统的技术设计文档，旨在：

1. 明确系统的技术架构和设计方案
2. 为开发人员提供详细的技术指导
3. 为测试人员提供测试依据
4. 为运维人员提供部署和维护参考

### 1.2 项目背景

随着人工智能技术的快速发展，用户对智能化服务的需求日益增长。SmartVoyage项目旨在构建一个基于多Agent协同的智能旅行助手系统，通过自然语言交互为用户提供便捷的旅行服务。

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| A2A | Agent to Agent，一种Agent间通信协议 |
| MCP | Model Context Protocol，模型上下文协议 |
| LLM | Large Language Model，大语言模型 |
| Agent | 具有特定功能的智能代理 |
| Task | A2A协议中的任务单元 |

### 1.4 参考资料

- A2A协议规范 v1.0
- MCP协议规范 v1.0
- 阿里云DashScope API文档
- LangChain框架文档

---

## 2. 系统概述

### 2.1 系统目标

构建一个基于A2A协议的多Agent协同旅行助手系统，实现：

1. **智能意图识别**：准确理解用户的旅行需求
2. **多Agent协同**：通过多个专业Agent协同完成复杂任务
3. **一站式服务**：提供天气、票务、订票等一站式旅行服务
4. **良好的用户体验**：支持自然语言交互，响应准确及时

### 2.2 功能范围

| 功能模块 | 功能描述 | 优先级 |
|----------|----------|:------:|
| 天气查询 | 查询指定城市的天气预报 | P0 |
| 火车票查询 | 查询高铁/火车票信息 | P0 |
| 机票查询 | 查询航班机票信息 | P0 |
| 演唱会票查询 | 查询演唱会门票信息 | P1 |
| 在线订票 | 支持各类票务预订 | P1 |
| 景点推荐 | 智能推荐旅游景点 | P2 |

### 2.3 用户角色

| 角色 | 描述 | 权限 |
|------|------|------|
| 普通用户 | 使用系统查询和预订服务 | 查询、预订 |
| 系统管理员 | 管理系统配置和数据 | 全部权限 |

### 2.4 系统约束

1. **技术约束**：基于Python 3.9+开发，使用MySQL 8.0+数据库
2. **性能约束**：单次查询响应时间≤5秒
3. **可用性约束**：系统可用性≥99%
4. **安全约束**：用户敏感信息需加密存储

---

## 3. 系统架构

### 3.1 总体架构

系统采用分层架构设计，包含以下层次：

```
┌─────────────────────────────────────────────────────────────────┐
│                          表现层                                  │
│                                                                 │
│     ┌─────────────────┐         ┌─────────────────┐            │
│     │  Streamlit Web  │         │   CLI 命令行     │            │
│     │    (app.py)     │         │   (main.py)     │            │
│     └────────┬────────┘         └────────┬────────┘            │
└──────────────┼──────────────────────────┼──────────────────────┘
               │                          │
               └────────────┬─────────────┘
                            │
┌───────────────────────────┼─────────────────────────────────────┐
│                           │       业务逻辑层                     │
│                           ▼                                     │
│              ┌─────────────────────────┐                        │
│              │      意图识别引擎        │                        │
│              │   (Intent Recognition)  │                        │
│              └────────────┬────────────┘                        │
│                           │                                     │
│         ┌─────────────────┼─────────────────┐                  │
│         │                 │                 │                  │
│         ▼                 ▼                 ▼                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Weather   │  │   Ticket    │  │    Order    │            │
│  │   Agent     │  │   Agent     │  │    Agent    │            │
│  │   :5005     │  │   :5006     │  │   :5007     │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└─────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │
┌─────────┼────────────────┼────────────────┼────────────────────┐
│         │                │                │    数据服务层       │
│         ▼                ▼                ▼                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ Weather MCP │  │ Ticket MCP  │  │  Order MCP  │            │
│  │    :8000    │  │    :8001    │  │    :8002    │            │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
└─────────┼────────────────┼────────────────┼────────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────────┐
│                          │          数据存储层                   │
│                          ▼                                      │
│              ┌─────────────────────────┐                        │
│              │     MySQL Database      │                        │
│              │      travel_rag         │                        │
│              │                         │                        │
│              │  ┌─────────────────┐    │                        │
│              │  │  weather_data   │    │                        │
│              │  │  train_tickets  │    │                        │
│              │  │  flight_tickets │    │                        │
│              │  │ concert_tickets │    │                        │
│              │  │     orders      │    │                        │
│              │  └─────────────────┘    │                        │
│              └─────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 技术选型

| 技术领域 | 选型方案 | 版本 | 选型理由 |
|----------|----------|------|----------|
| 开发语言 | Python | 3.9+ | 生态丰富，AI框架支持好 |
| Agent框架 | python-a2a | 0.1+ | 官方A2A协议SDK |
| MCP框架 | mcp | 0.1+ | 官方MCP协议SDK |
| LLM框架 | LangChain | 0.1+ | 成熟的LLM应用框架 |
| LLM服务 | 阿里云DashScope | - | 国内稳定，性价比高 |
| Web框架 | Streamlit | 1.28+ | 快速构建数据应用 |
| 数据库 | MySQL | 8.0+ | 成熟稳定，社区活跃 |
| HTTP客户端 | httpx | 0.25+ | 支持异步，现代化API |

### 3.3 模块划分

```
src/
├── config/              # 配置模块
│   ├── settings.py      # 全局配置
│   └── logging_config.py# 日志配置
│
├── agents/              # Agent服务模块
│   ├── base_agent.py    # Agent基类
│   ├── weather_agent.py # 天气Agent
│   ├── ticket_agent.py  # 票务Agent
│   └── order_agent.py   # 订票Agent
│
├── mcp_servers/         # MCP数据服务模块
│   ├── base_service.py  # 服务基类
│   ├── weather_mcp.py   # 天气MCP
│   ├── ticket_mcp.py    # 票务MCP
│   └── order_mcp.py     # 订单MCP
│
├── prompts/             # Prompt模板模块
│   └── templates.py     # Prompt定义
│
└── utils/               # 工具模块
    ├── formatters.py    # 格式化工具
    └── validators.py    # 验证工具
```

### 3.4 通信机制

#### 3.4.1 A2A通信协议

Agent间采用A2A协议通信，基于JSON-RPC 2.0规范：

**请求格式：**
```json
{
    "jsonrpc": "2.0",
    "method": "tasks/send",
    "params": {
        "message": {
            "role": "user",
            "content": "查询明天北京到上海的高铁票"
        }
    },
    "id": "uuid-string"
}
```

**响应格式：**
```json
{
    "jsonrpc": "2.0",
    "result": {
        "state": "completed",
        "message": {
            "role": "assistant",
            "content": "查询结果..."
        },
        "artifacts": []
    },
    "id": "uuid-string"
}
```

#### 3.4.2 任务状态

| 状态 | 描述 | 后续动作 |
|------|------|----------|
| completed | 任务完成 | 返回结果 |
| failed | 任务失败 | 返回错误信息 |
| input_required | 需要更多信息 | 返回追问消息 |
| working | 处理中 | 等待或轮询 |

---

## 4. 模块设计

### 4.1 意图识别模块

#### 4.1.1 功能描述

意图识别模块负责分析用户输入，识别用户意图并进行查询改写。

#### 4.1.2 支持的意图

| 意图标识 | 描述 | 示例 |
|----------|------|------|
| weather | 天气查询 | "北京明天天气" |
| train | 火车票查询 | "北京到上海的高铁" |
| flight | 机票查询 | "上海飞广州机票" |
| concert | 演唱会票查询 | "周杰伦演唱会" |
| order | 票务预订 | "订一张高铁票" |
| attraction | 景点推荐 | "北京有什么好玩的" |
| out_of_scope | 超出范围 | "今天股市怎么样" |

#### 4.1.3 处理流程

```
用户输入
    │
    ▼
┌─────────────────┐
│   预处理        │ ← 清理输入、提取关键信息
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  LLM意图识别    │ ← 调用大模型识别意图
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   查询改写      │ ← 结合历史上下文改写查询
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   结果输出      │ ← 输出意图和改写后的查询
└─────────────────┘
```

### 4.2 票务查询Agent

#### 4.2.1 功能描述

TicketQueryAgent负责处理火车票、机票、演唱会票的查询请求。

#### 4.2.2 核心流程

```
接收查询请求
      │
      ▼
┌──────────────┐
│  提取用户输入 │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  生成SQL语句 │ ← LLM将自然语言转为SQL
└──────┬───────┘
       │
       ├──────────────┐
       │              │
       ▼              ▼
  [信息完整]     [信息不足]
       │              │
       ▼              ▼
┌──────────────┐  ┌──────────────┐
│  调用MCP查询  │  │  返回追问消息 │
└──────┬───────┘  └──────────────┘
       │
       ▼
┌──────────────┐
│  格式化结果   │
└──────┬───────┘
       │
       ▼
   返回结果
```

#### 4.2.3 Agent Card配置

```python
AgentCard(
    name="TicketQueryAgent",
    description="票务查询代理，支持火车票、机票、演唱会票查询",
    url="http://localhost:5006",
    version="2.0.0",
    skills=[
        AgentSkill(name="query_train_ticket", description="查询火车票"),
        AgentSkill(name="query_flight_ticket", description="查询机票"),
        AgentSkill(name="query_concert_ticket", description="查询演唱会票")
    ]
)
```

### 4.3 订票Agent

#### 4.3.1 功能描述

OrderBookingAgent负责处理票务预订请求，包括信息验证、余票检查、订单创建。

#### 4.3.2 核心流程

```
接收订票请求
      │
      ▼
┌───────────────┐
│  解析订票意图  │
└───────┬───────┘
        │
        ▼
┌───────────────┐
│  验证联系人信息│
└───────┬───────┘
        │
        ├──────────────┐
        │              │
        ▼              ▼
   [信息完整]     [信息不足]
        │              │
        ▼              ▼
┌───────────────┐  ┌───────────────┐
│ 调用票务Agent │  │  返回追问消息  │
│   查询余票    │  └───────────────┘
└───────┬───────┘
        │
        ├──────────────┐
        │              │
        ▼              ▼
    [有余票]       [无余票]
        │              │
        ▼              ▼
┌───────────────┐  ┌───────────────┐
│ 调用订单MCP   │  │ 提示修改条件  │
│   创建订单    │  └───────────────┘
└───────┬───────┘
        │
        ▼
   返回订单结果
```

---

## 5. 数据库设计

### 5.1 数据库概述

| 属性 | 值 |
|------|-----|
| 数据库名 | travel_rag |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_unicode_ci |
| 存储引擎 | InnoDB |

### 5.2 表结构设计

#### 5.2.1 天气数据表 (weather_data)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| city | VARCHAR(50) | NOT NULL | 城市名称 |
| fx_date | DATE | NOT NULL | 预报日期 |
| temp_max | INT | | 最高温度 |
| temp_min | INT | | 最低温度 |
| text_day | VARCHAR(20) | | 白天天气 |
| text_night | VARCHAR(20) | | 夜间天气 |
| humidity | INT | | 湿度 |
| wind_dir_day | VARCHAR(20) | | 风向 |
| wind_scale_day | VARCHAR(10) | | 风力 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计：**
- 唯一索引：uk_city_date (city, fx_date)
- 普通索引：idx_city (city)
- 普通索引：idx_date (fx_date)

#### 5.2.2 火车票表 (train_tickets)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| departure_city | VARCHAR(50) | NOT NULL | 出发城市 |
| arrival_city | VARCHAR(50) | NOT NULL | 到达城市 |
| departure_time | DATETIME | NOT NULL | 出发时间 |
| arrival_time | DATETIME | NOT NULL | 到达时间 |
| train_number | VARCHAR(20) | NOT NULL | 车次号 |
| seat_type | VARCHAR(20) | NOT NULL | 座位类型 |
| total_seats | INT | NOT NULL | 总座位数 |
| remaining_seats | INT | NOT NULL | 剩余座位 |
| price | DECIMAL(10,2) | NOT NULL | 票价 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计：**
- 唯一索引：uk_train (train_number, departure_time, seat_type)
- 普通索引：idx_route (departure_city, arrival_city)
- 普通索引：idx_departure_time (departure_time)

#### 5.2.3 机票表 (flight_tickets)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| departure_city | VARCHAR(50) | NOT NULL | 出发城市 |
| arrival_city | VARCHAR(50) | NOT NULL | 到达城市 |
| departure_time | DATETIME | NOT NULL | 出发时间 |
| arrival_time | DATETIME | NOT NULL | 到达时间 |
| flight_number | VARCHAR(20) | NOT NULL | 航班号 |
| cabin_type | VARCHAR(20) | NOT NULL | 舱位类型 |
| total_seats | INT | NOT NULL | 总座位数 |
| remaining_seats | INT | NOT NULL | 剩余座位 |
| price | DECIMAL(10,2) | NOT NULL | 票价 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计：**
- 唯一索引：uk_flight (flight_number, departure_time, cabin_type)
- 普通索引：idx_route (departure_city, arrival_city)
- 普通索引：idx_departure_time (departure_time)

#### 5.2.4 演唱会票表 (concert_tickets)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| artist | VARCHAR(100) | NOT NULL | 艺人名称 |
| city | VARCHAR(50) | NOT NULL | 举办城市 |
| venue | VARCHAR(100) | NOT NULL | 场馆名称 |
| start_time | DATETIME | NOT NULL | 开始时间 |
| end_time | DATETIME | NOT NULL | 结束时间 |
| ticket_type | VARCHAR(20) | NOT NULL | 票类型 |
| total_seats | INT | NOT NULL | 总座位数 |
| remaining_seats | INT | NOT NULL | 剩余座位 |
| price | DECIMAL(10,2) | NOT NULL | 票价 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引设计：**
- 唯一索引：uk_concert (artist, city, start_time, ticket_type)
- 普通索引：idx_artist (artist)
- 普通索引：idx_city (city)

#### 5.2.5 订单表 (orders)

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INT | PK, AUTO_INCREMENT | 主键 |
| order_no | VARCHAR(32) | UNIQUE, NOT NULL | 订单号 |
| ticket_type | ENUM('train','flight','concert') | NOT NULL | 票务类型 |
| ticket_id | INT | NOT NULL | 票务ID |
| quantity | INT | NOT NULL DEFAULT 1 | 数量 |
| unit_price | DECIMAL(10,2) | NOT NULL | 单价 |
| total_price | DECIMAL(10,2) | NOT NULL | 总价 |
| contact_name | VARCHAR(50) | NOT NULL | 联系人 |
| contact_phone | VARCHAR(20) | NOT NULL | 电话 |
| contact_id_card | VARCHAR(20) | | 身份证号 |
| status | ENUM | DEFAULT 'pending' | 订单状态 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**订单状态枚举：**
- pending：待支付
- paid：已支付
- cancelled：已取消
- refunded：已退款
- completed：已完成

### 5.3 ER关系图

```
┌─────────────────┐
│  weather_data   │
├─────────────────┤
│ id (PK)         │
│ city            │
│ fx_date         │
│ temp_max        │
│ temp_min        │
│ ...             │
└─────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│ train_tickets   │     │ flight_tickets  │     │ concert_tickets │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id (PK)         │     │ id (PK)         │     │ id (PK)         │
│ departure_city  │     │ departure_city  │     │ artist          │
│ arrival_city    │     │ arrival_city    │     │ city            │
│ train_number    │     │ flight_number   │     │ venue           │
│ seat_type       │     │ cabin_type      │     │ ticket_type     │
│ price           │     │ price           │     │ price           │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                                 ▼
                    ┌─────────────────────────┐
                    │        orders           │
                    ├─────────────────────────┤
                    │ id (PK)                 │
                    │ order_no (UK)           │
                    │ ticket_type ────────┐   │
                    │ ticket_id (FK) ─────┼───┼──► train_tickets.id
                    │ quantity            │   │    flight_tickets.id
                    │ total_price         │   │    concert_tickets.id
                    │ contact_name        │   │
                    │ status              │   │
                    └─────────────────────────┘
```

---

## 6. 接口设计

### 6.1 A2A接口规范

#### 6.1.1 发送任务

**接口地址：** `POST /a2a`

**请求头：**
```
Content-Type: application/json
```

**请求参数：**
```json
{
    "jsonrpc": "2.0",
    "method": "tasks/send",
    "params": {
        "message": {
            "role": "user",
            "content": "用户消息内容"
        }
    },
    "id": "请求唯一标识"
}
```

**响应参数：**
```json
{
    "jsonrpc": "2.0",
    "result": {
        "state": "completed|failed|input_required",
        "message": {
            "role": "assistant",
            "content": "响应内容"
        },
        "artifacts": []
    },
    "id": "请求唯一标识"
}
```

#### 6.1.2 获取Agent卡片

**接口地址：** `GET /.well-known/agent.json`

**响应参数：**
```json
{
    "name": "Agent名称",
    "description": "Agent描述",
    "url": "Agent地址",
    "version": "版本号",
    "capabilities": {
        "streaming": false,
        "pushNotifications": false
    },
    "skills": [
        {
            "name": "技能名称",
            "description": "技能描述",
            "examples": ["示例1", "示例2"]
        }
    ]
}
```

### 6.2 MCP接口规范

#### 6.2.1 票务查询工具

**工具名称：** `query_tickets`

**参数：**
```json
{
    "sql": "SELECT * FROM train_tickets WHERE departure_city='北京' AND arrival_city='上海'"
}
```

**返回：**
```json
{
    "status": "success",
    "data": [
        {
            "id": 1,
            "departure_city": "北京",
            "arrival_city": "上海",
            "train_number": "G1001",
            "price": 553.50
        }
    ]
}
```

#### 6.2.2 创建订单工具

**工具名称：** `create_order`

**参数：**
```json
{
    "ticket_type": "train",
    "ticket_id": 123,
    "quantity": 1,
    "contact_name": "张三",
    "contact_phone": "13800138000",
    "contact_id_card": "110101199001011234"
}
```

**返回：**
```json
{
    "status": "success",
    "data": {
        "order_no": "ORD20260118123456",
        "total_price": 553.50,
        "status": "pending"
    }
}
```

### 6.3 外部API集成

| API | 用途 | 文档地址 |
|-----|------|----------|
| 和风天气 | 天气数据获取 | https://dev.qweather.com |
| Aviationstack | 航班数据获取 | https://aviationstack.com |
| Ticketmaster | 演唱会数据获取 | https://developer.ticketmaster.com |

---

## 7. 部署架构

### 7.1 环境要求

| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 20GB | 50GB+ |
| Python | 3.9 | 3.10+ |
| MySQL | 8.0 | 8.0+ |
| 操作系统 | Ubuntu 20.04 | Ubuntu 22.04 |

### 7.2 服务端口规划

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| Streamlit Web | 8501 | HTTP | Web用户界面 |
| Weather Agent | 5005 | HTTP/A2A | 天气查询服务 |
| Ticket Agent | 5006 | HTTP/A2A | 票务查询服务 |
| Order Agent | 5007 | HTTP/A2A | 订票服务 |
| Weather MCP | 8000 | HTTP/MCP | 天气数据服务 |
| Ticket MCP | 8001 | HTTP/MCP | 票务数据服务 |
| Order MCP | 8002 | HTTP/MCP | 订单数据服务 |
| MySQL | 3306 | TCP | 数据库服务 |

### 7.3 部署拓扑

```
                    ┌─────────────────┐
                    │   负载均衡器     │
                    │   (Nginx)       │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
       ┌──────────┐  ┌──────────┐  ┌──────────┐
       │ Web节点1 │  │ Web节点2 │  │ Web节点3 │
       │ :8501    │  │ :8501    │  │ :8501    │
       └────┬─────┘  └────┬─────┘  └────┬─────┘
            │             │             │
            └─────────────┼─────────────┘
                          │
       ┌──────────────────┼──────────────────┐
       │                  │                  │
       ▼                  ▼                  ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Weather     │  │ Ticket      │  │ Order       │
│ Agent:5005  │  │ Agent:5006  │  │ Agent:5007  │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       ▼                ▼                ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Weather     │  │ Ticket      │  │ Order       │
│ MCP:8000    │  │ MCP:8001    │  │ MCP:8002    │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │  MySQL数据库     │
              │  :3306          │
              └─────────────────┘
```

### 7.4 启动顺序

```bash
# 1. 启动数据库
systemctl start mysql

# 2. 启动MCP服务（数据层）
python -m src.mcp_servers.weather_mcp &
python -m src.mcp_servers.ticket_mcp &
python -m src.mcp_servers.order_mcp &

# 3. 等待MCP服务就绪
sleep 3

# 4. 启动Agent服务（业务层）
python -m src.agents.weather_agent &
python -m src.agents.ticket_agent &
python -m src.agents.order_agent &

# 5. 等待Agent服务就绪
sleep 3

# 6. 启动Web应用（表现层）
streamlit run src/app.py --server.port=8501
```

---

## 8. 安全设计

### 8.1 数据安全

| 安全措施 | 说明 |
|----------|------|
| 敏感信息加密 | 身份证号等敏感字段加密存储 |
| SQL注入防护 | 使用参数化查询，禁止拼接SQL |
| 输入验证 | 对所有用户输入进行合法性校验 |
| 数据备份 | 每日全量备份，实时binlog同步 |

### 8.2 通信安全

| 安全措施 | 说明 |
|----------|------|
| 内网通信 | Agent与MCP服务间使用内网IP |
| HTTPS | 生产环境Web服务启用HTTPS |
| API限流 | 单IP每分钟最多100次请求 |
| 请求签名 | 关键接口增加签名验证 |

### 8.3 访问控制

| 安全措施 | 说明 |
|----------|------|
| IP白名单 | MCP服务限制访问来源IP |
| API Key | 外部API调用需携带有效Key |
| 权限隔离 | 数据库用户按最小权限原则配置 |

### 8.4 日志审计

| 日志类型 | 保留时间 | 说明 |
|----------|----------|------|
| 访问日志 | 30天 | 记录所有接口访问 |
| 操作日志 | 90天 | 记录订单等关键操作 |
| 错误日志 | 90天 | 记录异常和错误 |
| 安全日志 | 180天 | 记录登录、权限变更等 |

---

## 附录

### 附录A：环境变量配置

```bash
# .env 配置文件示例

# 应用配置
DEBUG=false
LOG_LEVEL=INFO

# LLM配置
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_API_KEY=sk-your-api-key-here
LLM_MODEL_NAME=qwen-plus
LLM_TEMPERATURE=0.1

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your-password
DB_NAME=travel_rag

# Agent端口配置
WEATHER_AGENT_PORT=5005
TICKET_AGENT_PORT=5006
ORDER_AGENT_PORT=5007

# MCP端口配置
WEATHER_MCP_PORT=8000
TICKET_MCP_PORT=8001
ORDER_MCP_PORT=8002
```

### 附录B：常见问题

**Q1：服务启动时端口被占用怎么办？**

```bash
# 查找占用端口的进程
lsof -i :5006

# 终止进程
kill -9 <PID>
```

**Q2：数据库连接失败如何排查？**

1. 检查MySQL服务状态：`systemctl status mysql`
2. 检查用户名密码是否正确
3. 检查数据库是否存在：`mysql -e "SHOW DATABASES;"`
4. 检查防火墙设置：`ufw status`

**Q3：LLM调用超时怎么处理？**

1. 检查网络连接是否正常
2. 检查API Key是否有效
3. 适当增加超时时间配置
4. 检查DashScope服务状态

---

**文档结束**

<div align="center">

*SmartVoyage 智能旅行助手系统*

*技术设计文档 V2.0*

*Powered by kerro*

*Copyright © 2026 SmartVoyage Team. All Rights Reserved.*

</div>